<ion-content class="bg-surface">
  <div class="page-container page-enter pt-12 pb-24">
    <div class="header-subtitle breadcrumb-row">
      <button class="crumb-link" (click)="goToPrograms()"><ion-icon name="albums"></ion-icon><span>Programs</span></button>
      <span class="crumb-sep">></span>
      <span class="crumb-dim"><ion-icon name="list"></ion-icon><span>Routines</span></span>
    </div>
    <app-notch-header
      [title]="'Routines'"
      [icon]="'list'"
      [leadingActionIcon]="'chevron-back'"
      (leadingAction)="goToPrograms()"
      [secondaryActionIcon]="'add'"
      (secondaryAction)="createRoutine()">
    </app-notch-header>
    <div *ngIf="!isLoading" class="header-subtitle">
      <ion-icon name="list"></ion-icon>
      <span>{{ currentProgram ? filteredRoutines.length : routines.length }} routines</span>
      <span>â€¢</span>
      <ion-icon name="barbell"></ion-icon>
      <span>{{ getTotalExerciseCount() }} exercises</span>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="flex items-center justify-center h-64">
      <div class="space-y-4 text-center">
        <div class="w-12 h-12 bg-gray-800 rounded-full animate-pulse mx-auto"></div>
        <p class="text-gray-500 text-sm">Loading routines...</p>
      </div>
    </div>

    <div *ngIf="!isLoading && routines.length === 0" class="empty-glass empty-anim">
      <div class="empty-icon">
        <ion-icon name="list"></ion-icon>
      </div>
      <h2>No routines yet</h2>
      <p>Create your first routine to start building your perfect workout.</p>
      <div class="empty-action" (click)="createRoutine()">Create it now!</div>
    </div>

    <div *ngIf="!isLoading && filteredRoutines.length > 0" class="routines-list" cdkDropList [cdkDropListData]="filteredRoutines" [cdkDropListOrientation]="'vertical'" (cdkDropListDropped)="dropRoutines($event)">
      <div
        *ngFor="let routine of filteredRoutines; let i = index; trackBy: trackByRoutineId"
        (click)="editRoutine(routine)"
        class="glass-card routine-card"
        cdkDrag
        cdkDragLockAxis="y"
        [class.dragging]="draggingId===routine.id"
        (cdkDragStarted)="onRutDragStarted(routine.id)"
        (cdkDragEnded)="onRutDragEnded()"
        (cdkDragEntered)="onRutDragEntered(i)"
        (cdkDragExited)="onRutDragExited(i)"
        [class.drop-target]="hoverIndex===i"
        [class.card-initial]="initialAnimation"
        [class.card-enter]="enteringId === routine.id"
        [class.card-exit]="removingId === routine.id"
        [style.animationDelay]="(i * 160) + 'ms'"
        (animationend)="onCardAnimationEnd(routine)"
        [attr.id]="'routine-' + routine.id"
        >

        <!-- Routine Header -->
        <div class="card-header">
          <button class="drag-handle" aria-label="Drag to reorder" (click)="$event.stopPropagation()">
            <span class="dot"></span><span class="dot"></span>
            <span class="dot"></span><span class="dot"></span>
            <span class="dot"></span><span class="dot"></span>
          </button>
          <div class="header-text">
            <div class="card-title">{{ routine.name }}</div>
          </div>
          <div class="header-actions">
            <button class="action-button" (click)="$event.stopPropagation(); editRoutine(routine)">
              <ion-icon name="chevron-forward"></ion-icon>
            </button>
            <button class="action-button danger" (click)="onDeleteRoutine(routine, $event)">
              <ion-icon name="trash"></ion-icon>
            </button>
          </div>
        </div>

        <!-- Exercise Preview -->
        <div class="card-chips">
          <div *ngFor="let exercise of routine.exercises.slice(0, 3)" class="glass-chip">
            <span>{{ exercise.exerciseName }}</span>
          </div>
          <div
            *ngIf="routine.exercises.length > 3"
            class="glass-chip more">
            <span>+{{ routine.exercises.length - 3 }}</span>
          </div>
        </div>

        <!-- Stats -->
        <div class="card-stats">
          <div class="stat">
            <ion-icon name="barbell"></ion-icon>
            <span class="stat-text">{{ getTotalExercises(routine) }}</span>
          </div>
          <div class="stat">
            <ion-icon name="calendar"></ion-icon>
            <span class="stat-text">{{ todayDateShort }}</span>
          </div>
          <div class="stat">
            <ion-icon name="refresh"></ion-icon>
            <span class="stat-text">{{ getScheduleLabel(routine) }}</span>
          </div>
        </div>
        <div class="drag-preview" *cdkDragPreview>
          <div class="card-header">
            <button class="drag-handle" aria-label="Drag handle">
              <span class="dot"></span><span class="dot"></span>
              <span class="dot"></span><span class="dot"></span>
              <span class="dot"></span><span class="dot"></span>
            </button>
            <div class="header-text">
              <div class="card-title">{{ routine.name }}</div>
            </div>
            <div class="header-actions"></div>
          </div>
        </div>
        <div class="drag-placeholder" *cdkDragPlaceholder></div>
      </div>
    </div>

  </div>
</ion-content>
