<div class="modal-container" [class]="'animation-' + animationState">
  <div class="sticky top-0 z-50 modal-header">
    <div class="px-6 py-4">
      <div class="modal-notch">
        <div class="notch-title">
          <ion-icon name="list" class="modal-title-icon"></ion-icon>
          <span>{{ routineName?.trim() ? routineName : 'New routine' }}</span>
        </div>
        <div class="notch-center" role="tablist" aria-label="Routine tabs">
          <button
            class="notch-tab"
            [class.selected]="activeTab === 'exercises'"
            role="tab"
            [attr.aria-selected]="activeTab === 'exercises'"
            (click)="setTab('exercises')"
            aria-label="Exercises">
            <ion-icon name="barbell"></ion-icon>
          </button>
          <button
            class="notch-tab"
            [class.selected]="activeTab === 'info'"
            role="tab"
            [attr.aria-selected]="activeTab === 'info'"
            (click)="setTab('info')"
            aria-label="Information">
            <ion-icon name="information-circle"></ion-icon>
          </button>
        </div>
        <div class="notch-actions">
          <button class="notch-action" (click)="dismiss()" aria-label="Close modal">
            <ion-icon name="close"></ion-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="modal-body modal-enter" [class.info-padding]="activeTab === 'info'">
    <!-- Routine Info Section -->
    <div class="modal-card tab-enter tab-surface" *ngIf="activeTab === 'info'" [class.tab-slide-left]="tabTransition==='left'" [class.tab-slide-right]="tabTransition==='right'">
      <div class="modal-card-header">
        <div class="modal-card-title" style="margin-bottom: 10px;">
          <ion-icon name="create"></ion-icon>
          <span>Routine Information</span>
        </div>
      </div>
      <div class="modal-card-content content-surface">
        <div class="form-group">
          <label>Routine Name</label>
          <input
            type="text"
            [(ngModel)]="routineName"
            placeholder="Enter routine name"
            maxlength="50">
          <div class="helper">{{ routineName.length }}/50</div>
        </div>
        <div class="form-group">
          <label>Description (Optional)</label>
          <textarea
            [(ngModel)]="routineDescription"
            placeholder="Add a description..."
            rows="3"
            maxlength="200"></textarea>
          <div class="helper">{{ routineDescription.length }}/200</div>
        </div>
        <div class="form-group">
          <label class="days-label" style="margin-bottom: 8px;">Routine Days</label>
          <div class="days-selector" role="group" aria-label="Select days">
            <button
              *ngFor="let day of daysOptions"
              type="button"
              class="day-chip"
              [class.selected]="selectedDays.includes(day)"
              (click)="toggleDay(day)"
              [attr.aria-pressed]="selectedDays.includes(day)"
            >
              {{ day }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Exercises Section -->
    <div class="modal-card space-y-4 tab-enter tab-surface" *ngIf="activeTab === 'exercises'" [class.tab-slide-left]="tabTransition==='left'" [class.tab-slide-right]="tabTransition==='right'">
      <div class="modal-card-header">
        <div class="modal-card-title">
          <ion-icon name="barbell"></ion-icon>
          <span>Exercises</span>
        </div>
        <button (click)="openAddForm()" class="modal-add-btn" aria-label="Add exercise">
          <ion-icon name="add"></ion-icon>
          <span>Add exercise</span>
        </button>
      </div>

      <!-- Instant creation: exercise appears directly in the list -->

      <!-- Exercise List -->
      <div class="accordion-list content-surface" *ngIf="exercises.length > 0" cdkDropList [cdkDropListData]="exercises" [cdkDropListOrientation]="'vertical'" (cdkDropListDropped)="dropCdk($event)">
          <div
        *ngFor="let exercise of exercises; let i = index; trackBy: trackByExerciseId"
        class="exercise-item glass-item"
        cdkDrag
        cdkDragLockAxis="y"
        [class.dragging]="draggingId===exercise.exerciseId"
        (cdkDragStarted)="onDragStarted(exercise.exerciseId)"
        (cdkDragEnded)="onDragEnded()"
        (cdkDragEntered)="onDragEntered(i)"
        (cdkDragExited)="onDragExited(i)"
        [class.drop-target]="hoverIndex===i"
        [class.open]="isExpanded(exercise)"
        [class.slide-in]="animationState === 'entered'"
        [attr.id]="'exercise-' + exercise.exerciseId">

          <!-- Exercise Accordion Header -->
          <div
            class="accordion-header p-4 border-b"
            (click)="onHeaderClick(exercise)"
            [attr.aria-expanded]="isExpanded(exercise)"
            [attr.aria-controls]="'exercise-details-' + exercise.exerciseId">
            <button class="drag-handle" aria-label="Drag to reorder" (click)="$event.stopPropagation()">
              <span class="dot"></span><span class="dot"></span>
              <span class="dot"></span><span class="dot"></span>
              <span class="dot"></span><span class="dot"></span>
            </button>
            <div class="accordion-text">
              <div class="accordion-title">
                {{ exercise.exerciseName?.trim() ? exercise.exerciseName : 'Exercise name' }}
              </div>
              <div class="accordion-subtitle" aria-label="Exercise summary">
                <span class="subtitle-label">Sets</span> <span class="subtitle-number">{{ exercise.targetSets }}</span>
                • <span class="subtitle-label">Reps</span> <span class="subtitle-number">{{ exercise.targetReps }}</span>
              </div>
            </div>
            <div class="accordion-actions">
              <button (click)="removeExercise(i); $event.stopPropagation()" class="exercise-trash-btn" aria-label="Remove exercise">
                <ion-icon name="trash"></ion-icon>
              </button>
              <button class="accordion-toggle" aria-label="Toggle details" (click)="toggleExercise(exercise); $event.stopPropagation()">
                <ion-icon name="chevron-down" class="accordion-chevron" [class.expanded]="isExpanded(exercise)"></ion-icon>
              </button>
            </div>
          </div>
          <div class="drag-placeholder" *cdkDragPlaceholder></div>

          <!-- Exercise Details -->
          <div
            class="accordion-details p-4 exercise-details"
            [class.expanded]="isExpanded(exercise)"
            [attr.id]="'exercise-details-' + exercise.exerciseId">
            <div class="section-spacing">
              <div class="form-group" style="margin-bottom: 12px;">
                <label>Exercise Name</label>
                <input
                  type="text"
                  [(ngModel)]="exercise.exerciseName"
                  placeholder="Enter exercise name"
                  maxlength="50"
                  aria-label="Exercise name">
              </div>
              <div class="modal-card-header" style="justify-content: space-between; align-items: center;">
                <div class="modal-card-title">
                  <ion-icon name="swap-vertical"></ion-icon>
                  <span class="sets-label">Sets</span>
                </div>
                <button class="modal-add-set-btn" (click)="addSet(exercise)" aria-label="Add Set">
                  <ion-icon name="add"></ion-icon>
                  <span>Add Set</span>
                </button>
              </div>
              <div class="sets-table" *ngIf="getSets(exercise).length > 0">
                <table class="glass-table" aria-label="Sets table">
                  <thead>
                    <tr>
                      <th>Reps</th>
                      <th>Weight</th>
                      <th>RIR</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let s of getSets(exercise); let si = index; trackBy: trackBySetIndex">
                      <td>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" [ngModel]="getDisplayValue(exercise, si, 'reps')" (ngModelChange)="updateSetValue(exercise, si, 'reps', $event)" (focus)="onInputFocus(exercise, si, 'reps')" (blur)="onInputBlur(exercise, si, 'reps')" min="0" max="200" step="1" class="sf-input" aria-label="Reps" />
                      </td>
                      <td>
                        <div class="sf-combo">
                          <input type="number" inputmode="decimal" [ngModel]="getDisplayValue(exercise, si, 'weight')" (ngModelChange)="updateSetValue(exercise, si, 'weight', $event)" (focus)="onInputFocus(exercise, si, 'weight')" (blur)="onInputBlur(exercise, si, 'weight')" min="0" max="1000" step="0.1" class="sf-input" aria-label="Weight" />
                          <div class="unit-dd">
                            <button class="unit-dd-btn" (click)="toggleUnitDropdown(exercise, si)" [attr.aria-expanded]="isUnitDropdownOpen(exercise, si)">
                              <span class="label">{{ (s.unit || exercise.weightUnit)?.toUpperCase() }}</span>
                              <ion-icon [name]="isUnitDropdownOpen(exercise, si) ? 'chevron-up' : 'chevron-down'"></ion-icon>
                            </button>
                            <div class="unit-dd-menu" [class.open]="isUnitDropdownOpen(exercise, si)" [attr.aria-hidden]="!isUnitDropdownOpen(exercise, si)">
                              <button class="unit-dd-item" [class.selected]="(s.unit || exercise.weightUnit)==='kg'" [class.just-selected]="isUnitJustSelected(exercise, si)" (click)="setUnitForSet(exercise, si, 'kg')">KG</button>
                              <button class="unit-dd-item" [class.selected]="(s.unit || exercise.weightUnit)==='lb'" [class.just-selected]="isUnitJustSelected(exercise, si)" (click)="setUnitForSet(exercise, si, 'lb')">LB</button>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" [ngModel]="getDisplayValue(exercise, si, 'rir')" (ngModelChange)="updateSetValue(exercise, si, 'rir', $event)" (focus)="onInputFocus(exercise, si, 'rir')" (blur)="onInputBlur(exercise, si, 'rir')" min="0" max="10" step="1" class="sf-input" aria-label="RIR" />
                      </td>
                      <td>
                        <button class="exercise-trash-btn" (click)="removeSet(exercise, si)" aria-label="Eliminar set"><ion-icon name="trash"></ion-icon></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="sets-empty" *ngIf="getSets(exercise).length === 0">
                <div class="sets-empty-icon"><ion-icon name="swap-vertical"></ion-icon></div>
                <h4>No sets added</h4>
                <p class="sets-empty-sub">Add your first set to start configuring this exercise.</p>
              </div>
            </div>
            <div class="drag-preview" *cdkDragPreview>
              <div class="accordion-header">
                <button class="drag-handle" aria-label="Drag handle">
                  <span class="dot"></span><span class="dot"></span>
                  <span class="dot"></span><span class="dot"></span>
                  <span class="dot"></span><span class="dot"></span>
                </button>
                <div class="accordion-title">{{ exercise.exerciseName?.trim() ? exercise.exerciseName : 'Exercise name' }}</div>
                <div class="accordion-actions"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="exercises.length === 0" class="content-surface empty-center">
        <div class="modal-empty-glass">
          <div class="modal-empty-icon">
            <ion-icon name="barbell"></ion-icon>
          </div>
          <h3>No exercises added yet</h3>
          <p>Use the “Add exercise” button above to start.</p>
        </div>
      </div>
    </div>
  </div>
</div>
<button
  class="save-fab"
  aria-label="Save routine"
  (click)="saveRoutine()">
  <ion-icon name="save"></ion-icon>
</button>
