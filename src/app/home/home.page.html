<ion-content class="bg-surface">
  <div class="page-container page-enter pb-24" [class.training-active]="showTraining">
    <div class="top-controls" *ngIf="!showTraining">
      <div class="top-left">
        <button class="date-picker-btn" (click)="openDatePicker($event)" aria-label="Change day">
          <ion-icon name="calendar"></ion-icon>
          <span>{{ todayDateStr }}</span>
        </button>
      </div>
      <div class="top-right">
        <button class="lang-btn" (click)="toggleLanguage()" aria-label="Language">
          <ion-icon name="globe"></ion-icon>
          <span class="code">{{ selectedLanguage.toUpperCase() }}</span>
        </button>
      </div>
    </div>
    <app-notch-header
      *ngIf="!showTraining"
      [brandRed]="'Lift'"
      [brandWhite]="'Log'"
      [items]="[{icon:'list', text: routinesToday.length + ' routines'}, {icon:'barbell', text: totalExercisesToday + ' exercises'}]"
      [subtitleLabel]="todayLabel"
      [showTodayMark]="isSelectedToday">
    </app-notch-header>
    <ng-container *ngIf="!showTraining">
    <div *ngIf="!isLoading && totalExercisesToday > 0" class="header-subtitle scheduled-subtitle subtitle-anim">
      <div class="scheduled-left">
        <ion-icon name="calendar"></ion-icon>
        <span>{{ getScheduledLabel() }}</span>
      </div>
      <div class="scheduled-right">
        <button *ngIf="isSelectedToday && selectablePendingCountToday() > 0" class="check-all-btn" (click)="toggleSelectAll()" [attr.aria-pressed]="areAllSelectableSelected()">
          <ion-icon name="checkmark"></ion-icon>
          <span>{{ areAllSelectableSelected() ? 'Uncheck all' : 'Check all' }}</span>
        </button>
        <button class="program-filter-btn" (click)="showProgramFilter = !showProgramFilter" [attr.aria-expanded]="showProgramFilter" aria-controls="program-menu">
          <ion-icon *ngIf="selectedProgramFilter !== 'all'" name="funnel"></ion-icon>
          <ion-icon *ngIf="selectedProgramFilter === 'all'" name="apps"></ion-icon>
          <span>{{ selectedProgramFilter === 'all' ? 'All Programs' : selectedProgramFilter }}</span>
        </button>
      </div>
    </div>
    <div *ngIf="showProgramFilter" id="program-menu" class="program-menu">
      <button class="program-option" (click)="setProgramFilter('all')">
        <ion-icon name="apps"></ion-icon>
        <span>All Programs</span>
      </button>
      <button *ngFor="let p of getProgramsToday(); let i = index" class="program-option" [class.selected]="selectedProgramFilter===p" (click)="setProgramFilter(p)" [style.animationDelay]="(i * 60) + 'ms'" [attr.aria-selected]="selectedProgramFilter===p">
        <ion-icon *ngIf="selectedProgramFilter===p" name="checkmark"></ion-icon>
        <span>{{ p }}</span>
      </button>
    </div>

    <div *ngIf="isLoading" class="flex items-center justify-center h-64">
      <div class="space-y-4 text-center">
        <div class="w-12 h-12 bg-gray-800 rounded-full animate-pulse mx-auto"></div>
        <p class="text-gray-500 text-sm">Loading...</p>
      </div>
    </div>

    <div *ngIf="!isLoading && routinesToday.length === 0" class="today-empty empty-anim">
      <div class="empty-orb">
        <div class="orb-glow"></div>
        <ion-icon name="flame"></ion-icon>
      </div>
      <h2>{{ isSelectedToday ? 'Nothing scheduled today' : ('Nothing scheduled for ' + selectedDateUS + ' selected') }}</h2>
      <p *ngIf="isSelectedToday">You don't have any workout scheduled for today.</p>
      <p *ngIf="!isSelectedToday && isSelectedFuture">You don't have any workout scheduled for that day yet.</p>
      <div class="empty-sparkle"></div>
    </div>
    </ng-container>

    <div *ngIf="!isLoading && routinesToday.length > 0 && !showTraining" class="routines-list">
      <div *ngFor="let routine of filteredRoutinesToday(); let i = index" class="glass-card routine-card" [class.completed]="isRoutineCompleted(routine.id)" [class.completed-enter]="isRoutineCompleted(routine.id) && isJustCompleted(routine.id)"
        [style.animationDelay]="(i * 140) + 'ms'" (click)="openPreview(routine)">
        <div class="card-header">
          <div class="header-text">
            <div class="header-top">
              <div class="card-title">{{ routine.name }}</div>
              <span class="routine-tag">{{ routine.programName || 'Program' }}</span>
            </div>
          </div>
          <div class="header-actions">
            <span *ngIf="isRoutineCompleted(routine.id) && !isJustCompleted(routine.id)" class="done-tag" [class.done-enter]="isJustCompleted(routine.id)">Done</span>
            <button *ngIf="isRoutineCompleted(routine.id) && !isJustCompleted(routine.id)" class="action-button reset" (click)="$event.stopPropagation(); resetRoutineForToday(routine)">
              <ion-icon name="refresh"></ion-icon>
            </button>
            <button *ngIf="isSelectedToday && !isRoutineCompleted(routine.id) && !isJustCompleted(routine.id) && !showTraining" class="action-button select" [class.selected]="isRoutineSelected(routine.id)" [class.semi]="previewRoutine?.id===routine.id && !isRoutineSelected(routine.id)" (click)="$event.stopPropagation(); toggleRoutineSelection(routine.id)">
              <ion-icon name="checkmark"></ion-icon>
            </button>
            <div *ngIf="((showTraining && isRoutineSelected(routine.id) && !isRoutineCompleted(routine.id)) || isJustCompleted(routine.id))" class="action-button spinner" (click)="$event.stopPropagation()">
              <div class="spinner"></div>
            </div>

            <button class="action-button" (click)="openPreview(routine, $event)">
              <ion-icon name="chevron-down"></ion-icon>
            </button>
          </div>
        </div>
        <div class="card-chips">
          <div *ngFor="let exercise of routine.exercises.slice(0,3)" class="glass-chip">
            <span>{{ exercise.exerciseName }}</span>
          </div>
          <div *ngIf="routine.exercises.length > 3" class="glass-chip more">
            <span>+{{ routine.exercises.length - 3 }}</span>
          </div>
        </div>
        <div class="card-stats">
          <div class="stat">
            <ion-icon name="barbell"></ion-icon>
            <span>{{ routine.exercises.length }}</span>
          </div>
          <div class="stat">
            <ion-icon name="calendar"></ion-icon>
            <span>{{ todayDateShort }}</span>
          </div>
          <div class="stat">
            <ion-icon name="refresh"></ion-icon>
            <span>{{ getDaysPerWeekLabel(routine) }}</span>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="showTraining" class="training-view" [class.view-enter]="panelState==='entering'" [class.view-exit]="panelState==='exiting'">
      <div class="training-content">
      <div class="training-header">
        <div class="training-title"><ion-icon name="flame"></ion-icon><span>In progress</span></div>
        <div class="training-timer"><span class="timer-chip">{{ formatTimer() }}</span></div>
        <button class="finish-btn" (click)="finishTraining()">End Training</button>
      </div>
      <div class="training-stats">
        <div class="stat-chip">
          <ion-icon name="calendar"></ion-icon>
          <span>{{ todayDateShort }}</span>
        </div>
        <div class="stat-chip">
          <ion-icon name="barbell"></ion-icon>
          <span>{{ todayExercises.length }} exercises</span>
        </div>
        <div class="stat-chip">
          <ion-icon name="refresh"></ion-icon>
          <span>{{ getTotalTargetSets() }} sets</span>
        </div>
      </div>

      <div class="panel-body">
        <div class="accordion-list" *ngIf="todayExercises.length > 0">
          <div *ngFor="let exercise of todayExercises; let i = index" class="exercise-item glass-item" [attr.id]="'exercise-' + exercise.exerciseId">
            <div class="accordion-header p-4 border-b" (click)="toggleExercise(exercise)" [attr.aria-expanded]="isExpanded(exercise)" [attr.aria-controls]="'exercise-details-' + exercise.exerciseId">
              <div class="accordion-text">
                <div class="accordion-title">{{ exercise.exerciseName?.trim() ? exercise.exerciseName : 'Exercise' }} <span class="routine-tag title-chip">{{ getRoutineNameForExercise(exercise.exerciseId) }}</span></div>
                <div class="accordion-subtitle">
                  <span class="subtitle-label">Sets</span> <span class="subtitle-number">{{ exercise.targetSets }}</span>
                  • <span class="subtitle-label">Reps</span> <span class="subtitle-number">{{ exercise.targetReps }}</span>
                </div>
              </div>
              <div class="accordion-actions">
                <button class="accordion-toggle" aria-label="Toggle details" (click)="toggleExercise(exercise); $event.stopPropagation()">
                  <ion-icon name="chevron-down" class="accordion-chevron" [class.expanded]="isExpanded(exercise)"></ion-icon>
                </button>
              </div>
            </div>
            <div class="accordion-details p-4 exercise-details" [class.expanded]="isExpanded(exercise)" [attr.id]="'exercise-details-' + exercise.exerciseId">
              <div class="section-spacing">
                <div class="modal-card-header" style="justify-content: space-between; align-items: center;">
                  <div class="modal-card-title">
                    <ion-icon name="swap-vertical"></ion-icon>
                    <span class="sets-label">Sets</span>
                  </div>
                </div>
                <div class="sets-table" *ngIf="getSets(exercise).length > 0">
                  <table class="glass-table" aria-label="Sets table">
                    <thead>
                      <tr>
                        <th>Reps</th>
                        <th>Weight</th>
                        <th>RIR</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let s of getSets(exercise); let si = index; trackBy: trackBySetIndex">
                        <td>
                          <input type="number" inputmode="numeric" pattern="[0-9]*" [ngModel]="getDisplayValue(exercise, si, 'reps')" (ngModelChange)="updateSetValue(exercise, si, 'reps', $event)" (focus)="onInputFocus(exercise, si, 'reps')" (blur)="onInputBlur(exercise, si, 'reps')" min="0" max="200" step="1" class="sf-input" aria-label="Reps" />
                        </td>
                        <td>
                          <div class="sf-combo">
                            <input type="number" inputmode="decimal" [ngModel]="getDisplayValue(exercise, si, 'weight')" (ngModelChange)="updateSetValue(exercise, si, 'weight', $event)" (focus)="onInputFocus(exercise, si, 'weight')" (blur)="onInputBlur(exercise, si, 'weight')" min="0" max="1000" step="0.1" class="sf-input" aria-label="Weight" />
                            <div class="unit-dd">
                              <button class="unit-dd-btn" (click)="toggleUnitDropdown(exercise, si)" [attr.aria-expanded]="isUnitDropdownOpen(exercise, si)">
                                <span class="label">{{ (s.unit || exercise.weightUnit)?.toUpperCase() }}</span>
                                <ion-icon [name]="isUnitDropdownOpen(exercise, si) ? 'chevron-up' : 'chevron-down'"></ion-icon>
                              </button>
                              <div class="unit-dd-menu" [class.open]="isUnitDropdownOpen(exercise, si)" [attr.aria-hidden]="!isUnitDropdownOpen(exercise, si)">
                                <button class="unit-dd-item" [class.selected]="(s.unit || exercise.weightUnit)==='kg'" [class.just-selected]="isUnitJustSelected(exercise, si)" (click)="setUnitForSet(exercise, si, 'kg')">KG</button>
                                <button class="unit-dd-item" [class.selected]="(s.unit || exercise.weightUnit)==='lb'" [class.just-selected]="isUnitJustSelected(exercise, si)" (click)="setUnitForSet(exercise, si, 'lb')">LB</button>
                              </div>
                            </div>
                          </div>
                        </td>
                        <td>
                          <input type="number" inputmode="numeric" pattern="[0-9]*" [ngModel]="getDisplayValue(exercise, si, 'rir')" (ngModelChange)="updateSetValue(exercise, si, 'rir', $event)" (focus)="onInputFocus(exercise, si, 'rir')" (blur)="onInputBlur(exercise, si, 'rir')" min="0" max="10" step="1" class="sf-input" aria-label="RIR" />
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="sets-empty" *ngIf="getSets(exercise).length === 0">
                  <div class="sets-empty-icon"><ion-icon name="swap-vertical"></ion-icon></div>
                  <h4>No sets added</h4>
                  <p class="sets-empty-sub">Add your first set to start configuring this exercise.</p>
                </div>
              </div>
              <div class="notes-section section-spacing">
                <label class="text-gray-400 text-xs">Notes (Optional)</label>
                <div class="notes-box">
                  <textarea [(ngModel)]="exercise.notes" placeholder="How did it feel? Any cues or adjustments?" rows="3" class="notes-textarea" (change)="persistExercise(exercise)"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>
  <div *ngIf="!showTraining && !isLoading && routinesToday.length === 0 && isSelectedToday" class="start-day-alert subtitle-anim">
    <ion-icon name="information-circle"></ion-icon>
    <span>No routine assigned for this day. <span class="create-link" (click)="navigateToRoutines()">Create it now!</span></span>
  </div>
  <button *ngIf="!showTraining && isSelectedToday" class="start-day-fab" [class.done-mode]="areAllCompleted()" [disabled]="areAllCompleted() || !hasSelection()" (click)="openTrainingSelected()">
    <ion-icon name="flame"></ion-icon>
    <span>{{ getStartButtonText() }}</span>
  </button>
  <ion-modal [isOpen]="showPreview" class="preview-modal" (didDismiss)="closePreview()" initialBreakpoint="0.8"
    [breakpoints]="[0.6, 0.8, 1]" backdropDismiss="true">
    <ng-template>
      <div class="preview-container">
        <div class="preview-hero">
          <div class="preview-title">
            <ion-icon name="list" class="preview-icon"></ion-icon>
            <span>{{ previewRoutine?.name }}</span>
          </div>
          <button class="preview-close" (click)="closePreview()"><ion-icon name="close"></ion-icon></button>
        </div>
        <div class="preview-desc" *ngIf="previewRoutine?.description">
          <ion-icon name="information-circle" class="desc-icon"></ion-icon>
          <span class="desc-text">{{ previewRoutine?.description }}</span>
        </div>
        <div class="preview-meta-box">
          <div class="preview-meta">
            <div class="meta-item">
              <ion-icon name="calendar"></ion-icon>
              <span>{{ todayDateStr }}</span>
            </div>
            <div class="meta-item">
              <ion-icon name="barbell"></ion-icon>
              <span>{{ previewRoutine?.exercises?.length || 0 }}</span>
            </div>
            <div class="meta-item" *ngIf="previewRoutine?.days?.length">
              <ion-icon name="information-circle"></ion-icon>
              <span>{{ previewRoutine?.days?.join(', ') }}</span>
            </div>
          </div>
        </div>
        <div class="preview-body">
          <div class="preview-chips">
            <div *ngFor="let exercise of (previewRoutine?.exercises || []).slice(0,3)" class="glass-chip">
              <span>{{ exercise.exerciseName }}</span>
            </div>
            <div *ngIf="(previewRoutine?.exercises?.length || 0) > 3" class="glass-chip more">
              <span>+{{ (previewRoutine?.exercises?.length || 0) - 3 }}</span>
            </div>
          </div>
          <div class="preview-rows">
            <div *ngFor="let exercise of (previewRoutine?.exercises || [])" class="preview-row">
              <div class="pr-title">{{ exercise.exerciseName }}</div>
              <div class="pr-sub">
                <span>Sets {{ exercise.targetSets }}</span>
                <span>• Reps {{ exercise.targetReps }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </ion-modal>
  <ion-popover [isOpen]="showDatePicker" [event]="datePopoverEvent" class="date-popover" (didDismiss)="closeDatePicker()">
    <ng-template>
      <div class="custom-calendar">
        <div class="cal-header">
          <button class="nav-btn" (click)="prevMonth()"><ion-icon name="chevron-back"></ion-icon></button>
          <div class="cal-title text-gradient-primary">{{ calendarMonthLabel }} {{ calendarYear }}</div>
          <button class="nav-btn" (click)="nextMonth()"><ion-icon name="chevron-forward"></ion-icon></button>
        </div>
        <div class="cal-weekdays">
          <div class="wd" *ngFor="let wd of weekdayLabels">{{ wd }}</div>
        </div>
        <div class="cal-grid" [class.animate]="shouldAnimateDays">
          <button class="cal-day" *ngFor="let d of calendarDays; let i = index" [class.will-animate]="shouldAnimateDays" [class.outside]="!isCurrentMonth(d)" [class.today]="isToday(d)" [class.selected]="isSelected(d)" [class.trained]="isTrainedDay(d) && !isSelected(d)" [class.untrained]="isPastDay(d) && !isTrainedDay(d) && !isSelected(d)" [disabled]="isPastDay(d) && !isTrainedDay(d)" (click)="selectDate(d)" [style.animationDelay]="shouldAnimateDays ? (i * 30) + 'ms' : null">{{ getDayNumber(d) }}</button>
        </div>
        <div class="cal-legend">
          <div class="legend-item"><span class="legend-dot trained"></span><span>Entrenado</span></div>
          <div class="legend-item"><span class="legend-dot untrained"></span><span>No entrenado</span></div>
          <div class="legend-item"><span class="legend-dot selected"></span><span>Seleccionado</span></div>
        </div>
        <div class="cal-footer">
          <button class="footer-btn cancel" (click)="closeDatePicker()">Cancel</button>
          <button class="footer-btn done" (click)="confirmSelectedDate()">Done</button>
        </div>
      </div>
    </ng-template>
  </ion-popover>
</ion-content>
